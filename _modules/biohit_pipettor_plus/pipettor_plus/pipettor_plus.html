<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>biohit_pipettor_plus.pipettor_plus.pipettor_plus &#8212; biohit-pipettor-plus  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/nature.css?v=0f882399" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=a9d2d1f6" />
    <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">biohit-pipettor-plus  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">biohit_pipettor_plus.pipettor_plus.pipettor_plus</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for biohit_pipettor_plus.pipettor_plus.pipettor_plus</h1><div class="highlight"><pre>
<span></span><span class="k">class</span><span class="w"> </span><span class="nc">AbortException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when user aborts an operation&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">biohit_pipettor</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipettor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">biohit_pipettor.errors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CommandFailed</span>
<span class="c1">#from biohit_pipettor import PipettorSimulator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">biohit_pipettor_plus.pipettor_plus.mock_pipettor</span><span class="w"> </span><span class="kn">import</span> <span class="n">PipettorSimulator</span>


<span class="kn">from</span><span class="w"> </span><span class="nn">biohit_pipettor_plus.deck_structure</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">biohit_pipettor_plus.pipettor_plus.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">calculate_liquid_height</span><span class="p">,</span> <span class="n">calculate_dynamic_remove_height</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">biohit_pipettor_plus.pipettor_plus.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_config</span><span class="p">,</span> <span class="n">save_config</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">ceil</span>

<div class="viewcode-block" id="PipettorPlus">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PipettorPlus</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tip_volume</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">multichannel</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>  <span class="n">initialize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">deck</span><span class="p">:</span> <span class="n">Deck</span><span class="p">,</span>
                 <span class="n">tip_length</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mock_pipettor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interface to the Biohit Robo pipettor with deck/slot/labware structure</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tip_volume : Literal[200, 1000]</span>
<span class="sd">            The tip volume (must be 1000 if multichannel is True)</span>
<span class="sd">        multichannel : bool</span>
<span class="sd">            If True, it is assumed the device uses a multichannel pipet</span>
<span class="sd">        initialize : bool</span>
<span class="sd">            If True, the device will be initialized</span>
<span class="sd">        deck : Deck</span>
<span class="sd">            The deck containing slots and labware</span>
<span class="sd">        tip_length : float</span>
<span class="sd">            The tip length in mm</span>
<span class="sd">        mock_pipettor : bool</span>
<span class="sd">            If True, mock_pipettor will be used instead of Biohit Robo pipettor</span>
<span class="sd">                &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mock_pipettor</span><span class="p">:</span>
            <span class="n">pipettor_class</span> <span class="o">=</span> <span class="n">PipettorSimulator</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pipettor_class</span> <span class="o">=</span> <span class="n">Pipettor</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pipettor_context</span> <span class="o">=</span> <span class="n">pipettor_class</span><span class="p">(</span>
            <span class="n">tip_volume</span><span class="o">=</span><span class="n">tip_volume</span><span class="p">,</span>
            <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">,</span>
            <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">mock_pipettor</span> <span class="k">else</span> <span class="n">initialize</span><span class="p">,</span>
        <span class="p">)</span> <span class="c1"># initialize has to be true when using mock_pipettor as per documentation</span>

        <span class="c1"># Enter context immediately</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipettor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipettor_context</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_mode</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multichannel</span> <span class="o">=</span> <span class="n">multichannel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deck</span> <span class="o">=</span> <span class="n">deck</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_slots</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">deck</span><span class="o">.</span><span class="n">slots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abort_requested</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pause_requested</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">cfg</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">()</span>

        <span class="c1">#creates a dict of all tips, each tips having its own dict where content and volume in tip can be stored.</span>
        <span class="n">tip_lengths</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;TIP_LENGTHS&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tip_length</span> <span class="o">=</span> <span class="n">tip_length</span> <span class="k">if</span> <span class="n">tip_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tip_lengths</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">tip_volume</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;Pipettors_in_Multi&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multichannel</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tip_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_tips</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_tips</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tip_volume</span> <span class="o">=</span> <span class="n">tip_volume</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;MAX_BATCH_SIZE&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">foc_bat_script_path</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Forward any attribute access to the underlying pipettor&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;_pipettor&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; object has no attribute &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pipettor</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="PipettorPlus.close">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.close">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Manually close the pipettor connection and exit context&quot;&quot;&quot;</span>

        <span class="n">pipettor_context</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_pipettor_context&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pipettor_context</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pipettor_context</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing pipettor: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pipettor_context</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pipettor</span> <span class="o">=</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cleanup when object is destroyed&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="PipettorPlus.push_state">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.push_state">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">push_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save complete state snapshot for later restoration.&quot;&quot;&quot;</span>

        <span class="n">snapshot</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">slot_id</span><span class="p">,</span> <span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slots</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">slot</span><span class="o">.</span><span class="n">labware_stack</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Get topmost labware (highest max_z)</span>
            <span class="n">top_lw_id</span><span class="p">,</span> <span class="p">(</span><span class="n">top_lw</span><span class="p">,</span> <span class="p">(</span><span class="n">min_z</span><span class="p">,</span> <span class="n">max_z</span><span class="p">))</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">slot</span><span class="o">.</span><span class="n">labware_stack</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># item[1][1][1] = max_z</span>
            <span class="p">)</span>

            <span class="n">snapshot</span><span class="p">[</span><span class="n">top_lw</span><span class="o">.</span><span class="n">labware_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">top_lw</span><span class="o">.</span><span class="n">get_state_snapshot</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;has_tips&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_tips</span><span class="p">,</span>
            <span class="s1">&#39;tip_dict&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
            <span class="s1">&#39;deck_state&#39;</span><span class="p">:</span> <span class="n">snapshot</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="PipettorPlus.pop_state">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.pop_state">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pop_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Restore pipettor and deck state from snapshot.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_tips</span> <span class="o">=</span> <span class="n">snapshot</span><span class="p">[</span><span class="s1">&#39;has_tips&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tip_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="p">[</span><span class="s1">&#39;tip_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">deck_state_data</span> <span class="o">=</span> <span class="n">snapshot</span><span class="p">[</span><span class="s1">&#39;deck_state&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">slot_id</span><span class="p">,</span> <span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slots</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">slot</span><span class="o">.</span><span class="n">labware_stack</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Get topmost labware</span>
            <span class="n">top_lw_id</span><span class="p">,</span> <span class="p">(</span><span class="n">top_lw</span><span class="p">,</span> <span class="p">(</span><span class="n">min_z</span><span class="p">,</span> <span class="n">max_z</span><span class="p">))</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">slot</span><span class="o">.</span><span class="n">labware_stack</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">top_lw</span><span class="o">.</span><span class="n">labware_id</span> <span class="ow">in</span> <span class="n">deck_state_data</span><span class="p">:</span>
                <span class="n">top_lw</span><span class="o">.</span><span class="n">restore_state_snapshot</span><span class="p">(</span><span class="n">deck_state_data</span><span class="p">[</span><span class="n">top_lw</span><span class="o">.</span><span class="n">labware_id</span><span class="p">])</span></div>


<div class="viewcode-block" id="PipettorPlus.set_simulation_mode">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.set_simulation_mode">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_simulation_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enable or disable simulation mode.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_mode</span> <span class="o">=</span> <span class="n">enabled</span>
        <span class="k">if</span> <span class="n">enabled</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  → Simulation mode ENABLED &quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  → Simulation mode DISABLED&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_check_abort_and_pause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check for abort or pause requests at safe checkpoints&quot;&quot;&quot;</span>

        <span class="c1">#no need to check if in simulation mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_mode</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Check abort first (highest priority)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort_requested</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abort_requested</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Reset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">AbortException</span><span class="p">(</span><span class="s2">&quot;Operation aborted by user&quot;</span><span class="p">)</span>

        <span class="c1"># Check pause</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">pause_requested</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># Wait 100ms, check again</span>

            <span class="c1"># Allow abort even while paused</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort_requested</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pause_requested</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Unpause</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">abort_requested</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">AbortException</span><span class="p">(</span><span class="s2">&quot;Operation aborted by user&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="PipettorPlus.pick_tips">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.pick_tips">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pick_tips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipette_holder</span><span class="p">:</span> <span class="n">PipetteHolder</span><span class="p">,</span> <span class="n">list_col_row</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Pick tips from a PipetteHolder.</span>

<span class="sd">                Parameters</span>
<span class="sd">                ----------</span>
<span class="sd">                pipette_holder : PipetteHolder</span>
<span class="sd">                    PipetteHolder labware containing tips</span>
<span class="sd">                list_col_row : List[tuple[int, int]], optional</span>
<span class="sd">                    List of (column, row) grid indices to try.</span>
<span class="sd">                    If None, automatically finds occupied grid locations.</span>

<span class="sd">                Returns</span>
<span class="sd">                -------</span>
<span class="sd">                List[tuple[int, int]]</span>
<span class="sd">                    Actual (column, row) positions where tips were picked</span>

<span class="sd">                Raises</span>
<span class="sd">                ------</span>
<span class="sd">                ValueError</span>
<span class="sd">                    If pipettor already has tips or pipette holder not found</span>
<span class="sd">                &quot;&quot;&quot;</span>

        <span class="c1">#check if tips already exist.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_tips</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;pipettor already has tips&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multichannel</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pick_multi_tips</span><span class="p">(</span><span class="n">pipette_holder</span><span class="p">,</span> <span class="n">list_col_row</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pick_single_tip</span><span class="p">(</span><span class="n">pipette_holder</span><span class="p">,</span> <span class="n">list_col_row</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipettorPlus.pick_multi_tips">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.pick_multi_tips">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pick_multi_tips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipette_holder</span><span class="p">:</span> <span class="n">PipetteHolder</span><span class="p">,</span> <span class="n">list_col_row</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span>  <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pick tips from a PipetteHolder using multichannel pipettor.</span>

<span class="sd">        For multichannel, 8 consecutive tips are picked vertically.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pipette_holder : PipetteHolder</span>
<span class="sd">            PipetteHolder labware containing tips</span>
<span class="sd">        list_col_row : List[tuple[int, int]], optional</span>
<span class="sd">            List of (column, start_row) grid indices to try.</span>
<span class="sd">            start_row indicates where the first pipettor in multichannel would be positioned.</span>
<span class="sd">            If None, automatically finds all grid locations with 8 consecutive occupied tips.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[tuple[int, int]]</span>
<span class="sd">            Actual (column, start_row) position where tips were picked</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If not a multichannel pipettor or no tips available</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If failed to pick tips from any specified grid location</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">multichannel</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;pick_multi_tips requires multichannel pipettor&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">list_col_row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">occupied_col_row</span> <span class="o">=</span> <span class="n">pipette_holder</span><span class="o">.</span><span class="n">get_occupied_holder_multi</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">occupied_col_row</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No occupied multichannel grid locations found in pipette holder </span><span class="si">{</span><span class="n">pipette_holder</span><span class="o">.</span><span class="n">labware_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">list_col_row</span> <span class="o">=</span> <span class="n">occupied_col_row</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Auto-detected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">list_col_row</span><span class="p">)</span><span class="si">}</span><span class="s2"> multichannel grid locations: </span><span class="si">{</span><span class="n">list_col_row</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">list_col_row</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No col_row specified. list_col_row given : </span><span class="si">{</span><span class="n">list_col_row</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">start_row</span> <span class="ow">in</span> <span class="n">list_col_row</span><span class="p">:</span>
            <span class="c1">#checks the status of Individual pipette holders at  col_row</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">pipette_holder</span><span class="o">.</span><span class="n">check_col_start_row_multi</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">start_row</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;INVALID&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid location (</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">start_row</span><span class="si">}</span><span class="s2">) is invalid, skipping&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;FULLY_OCCUPIED&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid location (</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">start_row</span><span class="si">}</span><span class="s2">) is not fully occupied (status: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">), skipping&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># All positions valid and occupied - get holders</span>
            <span class="n">holders_to_use</span> <span class="o">=</span> <span class="p">[</span><span class="n">pipette_holder</span><span class="o">.</span><span class="n">get_holder_at</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">start_row</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="p">)]</span>

            <span class="c1"># All 8 holders are valid, attempt to pick tips</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_abort_and_pause</span><span class="p">()</span>
                <span class="n">first_holder</span> <span class="o">=</span> <span class="n">holders_to_use</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">first_holder</span><span class="o">.</span><span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Holder at grid location (</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">start_row</span><span class="si">}</span><span class="s2">) has no position set&quot;</span><span class="p">)</span>

                <span class="c1"># FIXED: Calculate center position</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_robot_xy_position</span><span class="p">(</span><span class="n">holders_to_use</span><span class="p">)</span>

                <span class="c1"># Pick tips at the specified height</span>
                <span class="n">first_holder</span> <span class="o">=</span> <span class="n">holders_to_use</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">relative_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relative_z</span><span class="p">(</span><span class="n">pipette_holder</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">pipettor_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pipettor_z_coord</span><span class="p">(</span><span class="n">pipette_holder</span><span class="p">,</span> <span class="n">relative_z</span><span class="p">,</span> <span class="n">child_item</span><span class="o">=</span><span class="n">first_holder</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">move_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pick_tip</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>

                <span class="c1"># Mark all 8 tips in this column as removed</span>
                <span class="n">pipette_holder</span><span class="o">.</span><span class="n">remove_consecutive_pipettes_multi</span><span class="p">([</span><span class="n">col</span><span class="p">],</span> <span class="n">start_row</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">has_tips</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ Successfully picked 8 tips from column </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, rows </span><span class="si">{</span><span class="n">start_row</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">start_row</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">7</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="n">start_row</span><span class="p">)]</span>

            <span class="k">except</span> <span class="n">CommandFailed</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✗ Failed to pick tips from column </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, row </span><span class="si">{</span><span class="n">start_row</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">move_z</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># If we got here, all attempts failed</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Failed to pick tips from any of the specified locations </span><span class="si">{</span><span class="n">list_col_row</span><span class="si">}</span><span class="s2">. &quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PipettorPlus.pick_single_tip">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.pick_single_tip">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pick_single_tip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipette_holder</span><span class="p">:</span> <span class="n">PipetteHolder</span><span class="p">,</span> <span class="n">list_col_row</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span>  <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pick a single tip from a PipetteHolder using single-channel pipettor.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multichannel</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;pick_single_tip requires single-channel pipettor&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">list_col_row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use existing method!</span>
            <span class="n">occupied_holders</span> <span class="o">=</span> <span class="n">pipette_holder</span><span class="o">.</span><span class="n">get_occupied_holders</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">occupied_holders</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No occupied tips found in pipette holder </span><span class="si">{</span><span class="n">pipette_holder</span><span class="o">.</span><span class="n">labware_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">list_col_row</span> <span class="o">=</span> <span class="p">[(</span><span class="n">h</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">occupied_holders</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Auto-detected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">list_col_row</span><span class="p">)</span><span class="si">}</span><span class="s2"> occupied tip positions&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">list_col_row</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No col_row specified. list_col_row given: </span><span class="si">{</span><span class="n">list_col_row</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">list_col_row</span><span class="p">:</span>
            <span class="n">holder</span> <span class="o">=</span> <span class="n">pipette_holder</span><span class="o">.</span><span class="n">get_holder_at</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">holder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid location (</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">) has no holder, skipping&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">holder</span><span class="o">.</span><span class="n">is_occupied</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid location (</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">) is empty, skipping&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_abort_and_pause</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">holder</span><span class="o">.</span><span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Holder at grid location (</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">) has no position set, skipping&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="n">position</span>

                <span class="n">relative_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relative_z</span><span class="p">(</span><span class="n">pipette_holder</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">pipettor_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pipettor_z_coord</span><span class="p">(</span><span class="n">pipette_holder</span><span class="p">,</span> <span class="n">relative_z</span><span class="p">,</span> <span class="n">child_item</span><span class="o">=</span><span class="n">holder</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">move_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pick_tip</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>

                <span class="n">holder</span><span class="o">.</span><span class="n">is_occupied</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">has_tips</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ Successfully picked tip from column </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, row </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">)]</span>

            <span class="k">except</span> <span class="n">CommandFailed</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✗ Failed to pick tip from column </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, row </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">holder</span><span class="o">.</span><span class="n">is_occupied</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">move_z</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Failed to pick tip from any of the specified locations </span><span class="si">{</span><span class="n">list_col_row</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PipettorPlus.return_tips">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.return_tips">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">return_tips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipette_holder</span><span class="p">:</span> <span class="n">PipetteHolder</span><span class="p">,</span> <span class="n">list_col_row</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; return tips to PipetteHolder. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_tips</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;pipettor have no tips to return&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multichannel</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_multi_tips</span><span class="p">(</span><span class="n">pipette_holder</span><span class="p">,</span> <span class="n">list_col_row</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_single_tip</span><span class="p">(</span><span class="n">pipette_holder</span><span class="p">,</span> <span class="n">list_col_row</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipettorPlus.return_multi_tips">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.return_multi_tips">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">return_multi_tips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipette_holder</span><span class="p">:</span> <span class="n">PipetteHolder</span><span class="p">,</span> <span class="n">list_col_row</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return tips to a PipetteHolder using multichannel pipettor.</span>

<span class="sd">        For multichannel, 8 consecutive tips are returned vertically.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pipette_holder : PipetteHolder</span>
<span class="sd">            PipetteHolder labware to return tips to</span>
<span class="sd">        list_col_row : List[tuple[int, int]], optional</span>
<span class="sd">            List of (column, start_row) grid indices to try.</span>
<span class="sd">            start_row indicates where the first pipettor in multichannel would be positioned.</span>
<span class="sd">            If None, automatically finds all grid locations with 8 consecutive empty positions.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If not a multichannel pipettor or no tips to return</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If failed to return tips to any specified grid location</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">multichannel</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;return_multi_tips requires multichannel pipettor&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_tips</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No tips to return - pipettor is empty&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">list_col_row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">available_col_row</span> <span class="o">=</span> <span class="n">pipette_holder</span><span class="o">.</span><span class="n">get_available_holder_multi</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">available_col_row</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No available multichannel grid locations found in pipette holder </span><span class="si">{</span><span class="n">pipette_holder</span><span class="o">.</span><span class="n">labware_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">list_col_row</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">available_col_row</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Auto-detected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">list_col_row</span><span class="p">)</span><span class="si">}</span><span class="s2"> available multichannel grid locations: </span><span class="si">{</span><span class="n">list_col_row</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">list_col_row</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No col_row specified. list_col_row given: </span><span class="si">{</span><span class="n">list_col_row</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">start_row</span> <span class="ow">in</span> <span class="n">list_col_row</span><span class="p">:</span>
            <span class="c1"># Check the status of positions</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">pipette_holder</span><span class="o">.</span><span class="n">check_col_start_row_multi</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">start_row</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;INVALID&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid location (</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">start_row</span><span class="si">}</span><span class="s2">) is invalid, skipping&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;FULLY_AVAILABLE&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid location (</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">start_row</span><span class="si">}</span><span class="s2">) is not fully available (status: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">), skipping&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># All positions valid and available - get holders</span>
            <span class="n">holders_to_use</span> <span class="o">=</span> <span class="p">[</span><span class="n">pipette_holder</span><span class="o">.</span><span class="n">get_holder_at</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">start_row</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="p">)]</span>

            <span class="c1"># Attempt to return tips</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_abort_and_pause</span><span class="p">()</span>
                <span class="n">first_holder</span> <span class="o">=</span> <span class="n">holders_to_use</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">first_holder</span><span class="o">.</span><span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Holder at grid location (</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">start_row</span><span class="si">}</span><span class="s2">) has no position set, skipping&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_robot_xy_position</span><span class="p">(</span><span class="n">holders_to_use</span><span class="p">)</span>

                <span class="c1"># Return tips at the specified height</span>
                <span class="n">first_holder</span> <span class="o">=</span> <span class="n">holders_to_use</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">relative_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relative_z</span><span class="p">(</span><span class="n">pipette_holder</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">pipettor_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pipettor_z_coord</span><span class="p">(</span><span class="n">pipette_holder</span><span class="p">,</span> <span class="n">relative_z</span><span class="p">,</span> <span class="n">child_item</span><span class="o">=</span><span class="n">first_holder</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">move_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">move_z</span><span class="p">(</span><span class="n">pipettor_z</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eject_tip</span><span class="p">()</span>
                <span class="c1"># Mark all 8 positions in this column as occupied</span>
                <span class="n">pipette_holder</span><span class="o">.</span><span class="n">place_consecutive_pipettes_multi</span><span class="p">([</span><span class="n">col</span><span class="p">],</span> <span class="n">start_row</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initialize_tips</span><span class="p">()</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ Successfully returned 8 tips to column </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, rows </span><span class="si">{</span><span class="n">start_row</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">start_row</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">7</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="n">start_row</span><span class="p">)]</span>

            <span class="k">except</span> <span class="n">CommandFailed</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✗ Failed to return tips to column </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, row </span><span class="si">{</span><span class="n">start_row</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">move_z</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># If we got here, all attempts failed</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Failed to return tips to any of the specified locations </span><span class="si">{</span><span class="n">list_col_row</span><span class="si">}</span><span class="s2">. &quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PipettorPlus.return_single_tip">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.return_single_tip">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">return_single_tip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipette_holder</span><span class="p">:</span> <span class="n">PipetteHolder</span><span class="p">,</span> <span class="n">list_col_row</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a single tip to a PipetteHolder using single-channel pipettor.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multichannel</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;return_single_tip requires single-channel pipettor&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_tips</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No tip to return - pipettor is empty&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">list_col_row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use existing method!</span>
            <span class="n">available_holders</span> <span class="o">=</span> <span class="n">pipette_holder</span><span class="o">.</span><span class="n">get_available_holders</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">available_holders</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No available positions found in pipette holder </span><span class="si">{</span><span class="n">pipette_holder</span><span class="o">.</span><span class="n">labware_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">list_col_row</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([(</span><span class="n">h</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">available_holders</span><span class="p">],</span>
                                  <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Auto-detected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">list_col_row</span><span class="p">)</span><span class="si">}</span><span class="s2"> available tip positions&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">list_col_row</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No col_row specified. list_col_row given: </span><span class="si">{</span><span class="n">list_col_row</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">list_col_row</span><span class="p">:</span>
            <span class="n">holder</span> <span class="o">=</span> <span class="n">pipette_holder</span><span class="o">.</span><span class="n">get_holder_at</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">holder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid location (</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">) has no holder, skipping&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">holder</span><span class="o">.</span><span class="n">is_occupied</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid location (</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">) is already occupied, skipping&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_abort_and_pause</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">holder</span><span class="o">.</span><span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Holder at grid location (</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">) has no position set, skipping&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="n">position</span>
                <span class="n">relative_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relative_z</span><span class="p">(</span><span class="n">pipette_holder</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">pipettor_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pipettor_z_coord</span><span class="p">(</span><span class="n">pipette_holder</span><span class="p">,</span> <span class="n">relative_z</span><span class="p">,</span> <span class="n">child_item</span><span class="o">=</span><span class="n">holder</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">move_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">move_z</span><span class="p">(</span><span class="n">pipettor_z</span><span class="p">)</span>  <span class="c1"># return_height</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eject_tip</span><span class="p">()</span>

                <span class="n">holder</span><span class="o">.</span><span class="n">is_occupied</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initialize_tips</span><span class="p">()</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ Successfully returned tip to column </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, row </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">)]</span>

            <span class="k">except</span> <span class="n">CommandFailed</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✗ Failed to return tip to column </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, row </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">move_z</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Failed to return tip to any of the specified locations </span><span class="si">{</span><span class="n">list_col_row</span><span class="si">}</span><span class="s2">. &quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PipettorPlus.replace_tips">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.replace_tips">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">replace_tips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipette_holder</span><span class="p">:</span> <span class="n">PipetteHolder</span><span class="p">,</span> <span class="n">pick_pipette_holder</span><span class="p">:</span><span class="n">PipetteHolder</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">return_list_col_row</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">pick_list_col_row</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pick_pipette_holder</span><span class="p">:</span>
            <span class="n">pick_pipette_holder</span> <span class="o">=</span> <span class="n">pipette_holder</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_abort_and_pause</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multichannel</span><span class="p">:</span>
            <span class="c1"># get list of available holders</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">return_list_col_row</span><span class="p">:</span>
                <span class="n">available_col_row</span> <span class="o">=</span> <span class="n">pipette_holder</span><span class="o">.</span><span class="n">get_available_holder_multi</span><span class="p">()</span>
                <span class="n">return_list_col_row</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">available_col_row</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># get list of occupied holders</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pick_list_col_row</span><span class="p">:</span>
                <span class="n">pick_list_col_row</span> <span class="o">=</span> <span class="n">pick_pipette_holder</span><span class="o">.</span><span class="n">get_occupied_holder_multi</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">return_list_col_row</span><span class="p">:</span>
                <span class="n">available_holders</span> <span class="o">=</span> <span class="n">pipette_holder</span><span class="o">.</span><span class="n">get_available_holders</span><span class="p">()</span>
                <span class="c1"># Sort high to low for returning</span>
                <span class="n">return_list_col_row</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([(</span><span class="n">h</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">available_holders</span><span class="p">],</span>
                                             <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pick_list_col_row</span><span class="p">:</span>
                <span class="n">occupied_holders</span> <span class="o">=</span> <span class="n">pick_pipette_holder</span><span class="o">.</span><span class="n">get_occupied_holders</span><span class="p">()</span>
                <span class="n">pick_list_col_row</span> <span class="o">=</span> <span class="p">[(</span><span class="n">h</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">occupied_holders</span><span class="p">]</span>  <span class="c1"># Convert to list of occupied_holders!</span>

        <span class="n">actual_return_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_tips</span><span class="p">(</span><span class="n">pipette_holder</span><span class="p">,</span> <span class="n">list_col_row</span><span class="o">=</span><span class="n">return_list_col_row</span><span class="p">)</span>
        <span class="n">actual_pick_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pick_tips</span><span class="p">(</span><span class="n">pick_pipette_holder</span><span class="p">,</span> <span class="n">list_col_row</span><span class="o">=</span><span class="n">pick_list_col_row</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">actual_return_pos</span><span class="p">,</span>
            <span class="s1">&#39;pick&#39;</span><span class="p">:</span> <span class="n">actual_pick_pos</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="PipettorPlus.discard_tips">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.discard_tips">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">discard_tips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tip_dropzone</span><span class="p">:</span> <span class="n">Labware</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Discard tips to a TipDropzone.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tip_dropzone : labware</span>
<span class="sd">            TipDropzone labware</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_abort_and_pause</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_tips</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No tips to discard&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tip_dropzone</span><span class="p">,</span> <span class="n">TipDropzone</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;discard_tips only works with TipDropzone&quot;</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">tip_dropzone</span><span class="o">.</span><span class="n">position</span>
        <span class="n">relative_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relative_z</span><span class="p">(</span><span class="n">tip_dropzone</span><span class="p">)</span>
        <span class="n">pipettor_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pipettor_z_coord</span><span class="p">(</span><span class="n">tip_dropzone</span><span class="p">,</span> <span class="n">relative_z</span><span class="p">,</span> <span class="n">child_item</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">move_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_z</span><span class="p">(</span><span class="n">pipettor_z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eject_tip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_z</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_tips</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipettorPlus.add_medium">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.add_medium">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_medium</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">ReservoirHolder</span><span class="p">,</span> <span class="n">source_col_row</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
                   <span class="n">volume_per_well</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">destination</span><span class="p">:</span> <span class="n">Plate</span><span class="p">,</span>
                   <span class="n">dest_col_row</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">mix_volume</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transfer medium from a reservoir to destination plate column(s).</span>
<span class="sd">        Works for both single-channel and multichannel pipettors.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : ReservoirHolder</span>
<span class="sd">            ReservoirHolder containing the medium to transfer</span>
<span class="sd">        source_col_row : tuple[int, int]</span>
<span class="sd">            (Column, Row) position of reservoir.</span>
<span class="sd">        volume_per_well : float</span>
<span class="sd">            Volume (µL) to dispense into each destination well</span>
<span class="sd">        destination : Plate</span>
<span class="sd">            Target plate to receive the medium</span>
<span class="sd">        dest_col_row : List[tuple[int, int]]</span>
<span class="sd">            List of (Column, Row) positions in destination plate.</span>
<span class="sd">            Row is start row for multichannel pipettor.</span>
<span class="sd">        mix_volume : float, optional</span>
<span class="sd">            Volume (µL) to use for mixing after dispensing.</span>
<span class="sd">            0 = no mixing (default)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate (source needs 1 row, destinations need tip_count rows)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_transfer</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="p">[</span><span class="n">source_col_row</span><span class="p">],</span> <span class="n">destination</span><span class="p">,</span> <span class="n">dest_col_row</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="p">)</span>

        <span class="c1"># Calculate volumes</span>
        <span class="n">volume_per_destination</span><span class="p">,</span> <span class="n">max_vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_volumes</span><span class="p">(</span><span class="n">volume_per_well</span><span class="p">)</span>

        <span class="n">original_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_tips</span> <span class="ow">or</span> <span class="n">mix_volume</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Choose strategy</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">volume_per_destination</span> <span class="o">&gt;</span> <span class="n">max_vol</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_multi_trip_transfer</span><span class="p">(</span><span class="n">dest_col_row</span><span class="p">,</span> <span class="n">volume_per_destination</span><span class="p">,</span> <span class="n">max_vol</span><span class="p">,</span>
                                          <span class="n">source</span><span class="p">,</span> <span class="n">source_col_row</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">is_one_to_many</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mix_volume</span><span class="o">=</span><span class="n">mix_volume</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_batch_transfer</span><span class="p">(</span><span class="n">dest_col_row</span><span class="p">,</span> <span class="n">volume_per_destination</span><span class="p">,</span> <span class="n">max_vol</span><span class="p">,</span>
                                     <span class="n">source</span><span class="p">,</span> <span class="n">source_col_row</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">is_one_to_many</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mix_volume</span><span class="o">=</span><span class="n">mix_volume</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">original_batch_size</span></div>


<div class="viewcode-block" id="PipettorPlus.remove_medium">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.remove_medium">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_medium</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">Plate</span><span class="p">,</span> <span class="n">source_col_row</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
                      <span class="n">volume_per_well</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">destination</span><span class="p">:</span> <span class="n">ReservoirHolder</span><span class="p">,</span>
                      <span class="n">destination_col_row</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove medium from plate wells to a destination reservoir.</span>
<span class="sd">        Works for both single-channel and multichannel pipettors.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : Plate</span>
<span class="sd">            Plate to remove medium from</span>
<span class="sd">        source_col_row : List[tuple[int, int]]</span>
<span class="sd">            List of (Column, Row) positions to remove from.</span>
<span class="sd">            Row is start row for multichannel pipettor.</span>
<span class="sd">        volume_per_well : float</span>
<span class="sd">            Volume (µL) to remove from each well</span>
<span class="sd">        destination : ReservoirHolder</span>
<span class="sd">            ReservoirHolder to receive the liquid</span>
<span class="sd">        destination_col_row : tuple[int, int]</span>
<span class="sd">            (Column, Row) position of destination reservoir.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate (sources need tip_count rows, destination needs 1 row)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_transfer</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">source_col_row</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="p">[</span><span class="n">destination_col_row</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Calculate volumes</span>
        <span class="n">volume_per_source</span><span class="p">,</span> <span class="n">max_vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_volumes</span><span class="p">(</span><span class="n">volume_per_well</span><span class="p">)</span>

        <span class="c1"># Choose strategy</span>
        <span class="n">original_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_tips</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">volume_per_source</span> <span class="o">&gt;</span> <span class="n">max_vol</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_multi_trip_transfer</span><span class="p">(</span><span class="n">source_col_row</span><span class="p">,</span> <span class="n">volume_per_source</span><span class="p">,</span> <span class="n">max_vol</span><span class="p">,</span>
                                          <span class="n">source</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">destination_col_row</span><span class="p">,</span> <span class="n">is_one_to_many</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_batch_transfer</span><span class="p">(</span><span class="n">source_col_row</span><span class="p">,</span> <span class="n">volume_per_source</span><span class="p">,</span> <span class="n">max_vol</span><span class="p">,</span>
                                     <span class="n">source</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">destination_col_row</span><span class="p">,</span> <span class="n">is_one_to_many</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">original_batch_size</span></div>


<div class="viewcode-block" id="PipettorPlus.transfer_plate_to_plate">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.transfer_plate_to_plate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transfer_plate_to_plate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">Plate</span><span class="p">,</span> <span class="n">source_col_row</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
                                <span class="n">destination</span><span class="p">:</span> <span class="n">Plate</span><span class="p">,</span> <span class="n">dest_col_row</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
                                <span class="n">volume_per_well</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">mix_volume</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transfer liquid from source plate to destination plate (one-to-one mapping).</span>
<span class="sd">        Works for both single-channel and multichannel pipettors.</span>

<span class="sd">        Each source position is transferred to the corresponding destination position.</span>
<span class="sd">        source_col_row[i] → dest_col_row[i]</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : Plate</span>
<span class="sd">            Source plate</span>
<span class="sd">        source_col_row : List[tuple[int, int]]</span>
<span class="sd">            List of source (Column, Row) positions.</span>
<span class="sd">            Row is start row for multichannel pipettor.</span>
<span class="sd">        destination : Plate</span>
<span class="sd">            Destination plate</span>
<span class="sd">        dest_col_row : List[tuple[int, int]]</span>
<span class="sd">            List of destination (Column, Row) positions.</span>
<span class="sd">            Must be same length as source_col_row.</span>
<span class="sd">        volume_per_well : float</span>
<span class="sd">            Volume (µL) to transfer from each well</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If source and destination lists have different lengths</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate list lengths match</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_col_row</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dest_col_row</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Source and destination lists must be same length. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">source_col_row</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dest_col_row</span><span class="p">)</span><span class="si">}</span><span class="s2"> destinations.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Validate all positions (both need tip_count rows)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_transfer</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">source_col_row</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">dest_col_row</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="p">)</span>

        <span class="c1"># Calculate volumes</span>
        <span class="n">volume_per_transfer</span><span class="p">,</span> <span class="n">max_vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_volumes</span><span class="p">(</span><span class="n">volume_per_well</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plate-to-plate transfer (one-to-one)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of transfers: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">source_col_row</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Volume per well: </span><span class="si">{</span><span class="n">volume_per_well</span><span class="si">}</span><span class="s2">µL&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Volume per transfer: </span><span class="si">{</span><span class="n">volume_per_transfer</span><span class="si">}</span><span class="s2">µL&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max volume per aspirate: </span><span class="si">{</span><span class="n">max_vol</span><span class="si">}</span><span class="s2">µL</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Process each source → destination pair</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">src_pos</span><span class="p">,</span> <span class="n">dst_pos</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">source_col_row</span><span class="p">,</span> <span class="n">dest_col_row</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">src_col</span><span class="p">,</span> <span class="n">src_row</span> <span class="o">=</span> <span class="n">src_pos</span>
            <span class="n">dst_col</span><span class="p">,</span> <span class="n">dst_row</span> <span class="o">=</span> <span class="n">dst_pos</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transfer </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">source_col_row</span><span class="p">)</span><span class="si">}</span><span class="s2">: (</span><span class="si">{</span><span class="n">src_col</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">src_row</span><span class="si">}</span><span class="s2">) → (</span><span class="si">{</span><span class="n">dst_col</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">dst_row</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">check_tips</span><span class="p">()</span>
            <span class="c1"># Check if multi-trip needed</span>
            <span class="k">if</span> <span class="n">volume_per_transfer</span> <span class="o">&gt;</span> <span class="n">max_vol</span><span class="p">:</span>
                <span class="c1"># Multi-trip for this pair</span>
                <span class="n">num_trips</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="n">volume_per_transfer</span> <span class="o">/</span> <span class="n">max_vol</span><span class="p">)</span>
                <span class="n">base_volume</span> <span class="o">=</span> <span class="n">volume_per_transfer</span> <span class="o">//</span> <span class="n">num_trips</span>
                <span class="n">remainder</span> <span class="o">=</span> <span class="n">volume_per_transfer</span> <span class="o">%</span> <span class="n">num_trips</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">num_trips</span><span class="si">}</span><span class="s2"> trips needed&quot;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">trip_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_trips</span><span class="p">):</span>
                    <span class="n">trip_volume</span> <span class="o">=</span> <span class="n">base_volume</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">trip_num</span> <span class="o">&lt;</span> <span class="n">remainder</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">suck</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">src_pos</span><span class="p">,</span> <span class="n">trip_volume</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spit</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">dst_pos</span><span class="p">,</span> <span class="n">trip_volume</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Trip </span><span class="si">{</span><span class="n">trip_num</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_trips</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">trip_volume</span><span class="si">}</span><span class="s2">µL&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Single transfer</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suck</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">src_pos</span><span class="p">,</span> <span class="n">volume_per_transfer</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spit</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">dst_pos</span><span class="p">,</span> <span class="n">volume_per_transfer</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ </span><span class="si">{</span><span class="n">volume_per_transfer</span><span class="si">}</span><span class="s2">µL transferred&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">mix_volume</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">actual_mix_vol</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">mix_volume</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_volume</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    → Mixing with </span><span class="si">{</span><span class="n">actual_mix_vol</span><span class="si">}</span><span class="s2">µL&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suck</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">dst_pos</span><span class="p">,</span> <span class="n">actual_mix_vol</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spit</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">dst_pos</span><span class="p">,</span> <span class="n">actual_mix_vol</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ Plate-to-plate transfer complete</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="PipettorPlus.suck">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.suck">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">suck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">Labware</span><span class="p">,</span> <span class="n">source_col_row</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Aspirate from a source labware.</span>

<span class="sd">        Works with any labware type. If labware supports content tracking, content is tracked.</span>
<span class="sd">        If not, only physical movement is performed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : Labware</span>
<span class="sd">            Source labware (Plate, ReservoirHolder, or any other labware)</span>
<span class="sd">        source_col_row : tuple[int, int]</span>
<span class="sd">            (Column, Row) position in source labware</span>
<span class="sd">        volume : float</span>
<span class="sd">            Total volume to aspirate across all tips (µL)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source_col</span><span class="p">,</span> <span class="n">source_row</span> <span class="o">=</span> <span class="n">source_col_row</span>

        <span class="k">if</span> <span class="n">volume</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Volume must be positive&quot;</span><span class="p">)</span>

        <span class="c1"># Validate based on whether it&#39;s a reservoir or not</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="o">.</span><span class="n">each_tip_needs_separate_item</span><span class="p">():</span>
            <span class="c1"># like for Reservoir: all tips access same reservoir</span>
            <span class="n">source</span><span class="o">.</span><span class="n">validate_col_row_or_raise</span><span class="p">([</span><span class="n">source_col</span><span class="p">],</span> <span class="n">source_row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Plate or other grid labware: each tip accesses different position</span>
            <span class="n">source</span><span class="o">.</span><span class="n">validate_col_row_or_raise</span><span class="p">([</span><span class="n">source_col</span><span class="p">],</span> <span class="n">source_row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_supports_content_management</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">source_col</span><span class="p">,</span> <span class="n">source_row</span><span class="p">):</span>
            <span class="c1"># Track content if supported</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aspirate_with_content_tracking</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">source_col</span><span class="p">,</span> <span class="n">source_row</span><span class="p">,</span> <span class="n">volume</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  → Aspirated </span><span class="si">{</span><span class="n">volume</span><span class="si">}</span><span class="s2">µL from </span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">labware_id</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">source_col_row</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  → Tip content now: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_tip_content_summary</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Just do physical movement without content tracking</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aspirate_physical_only</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">source_col</span><span class="p">,</span> <span class="n">source_row</span><span class="p">,</span> <span class="n">volume</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  → Aspirated </span><span class="si">{</span><span class="n">volume</span><span class="si">}</span><span class="s2">µL from </span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">labware_id</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">source_col_row</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipettorPlus.spit">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.spit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">spit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destination</span><span class="p">:</span> <span class="n">Labware</span><span class="p">,</span> <span class="n">dest_col_row</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dispense from tips to a destination labware.</span>

<span class="sd">        Works with any labware type. If labware supports content tracking, content is tracked.</span>
<span class="sd">        If not, only physical movement is performed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        destination : Labware</span>
<span class="sd">            Destination labware (Plate, ReservoirHolder, or any other labware)</span>
<span class="sd">        dest_col_row : tuple[int, int]</span>
<span class="sd">            (Column, Row) position in destination labware</span>
<span class="sd">        volume : float</span>
<span class="sd">            Total volume to dispense across all tips (µL)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dest_col</span><span class="p">,</span> <span class="n">dest_row</span> <span class="o">=</span> <span class="n">dest_col_row</span>

        <span class="k">if</span> <span class="n">volume</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Volume must be positive&quot;</span><span class="p">)</span>

        <span class="c1"># Check we have enough volume in tips</span>
        <span class="n">total_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_total_tip_volume</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">total_available</span> <span class="o">&lt;</span> <span class="n">volume</span><span class="p">:</span>
            <span class="n">difference</span> <span class="o">=</span> <span class="n">volume</span> <span class="o">-</span> <span class="n">total_available</span>
            <span class="k">if</span> <span class="n">difference</span> <span class="o">&lt;=</span> <span class="mf">0.01</span><span class="p">:</span>
                <span class="n">volume</span> <span class="o">=</span> <span class="n">total_available</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Insufficient volume in tips. Available: </span><span class="si">{</span><span class="n">total_available</span><span class="si">}</span><span class="s2">µL, Requested: </span><span class="si">{</span><span class="n">volume</span><span class="si">}</span><span class="s2">µL&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Validate based on whether destination needs separate items per tip</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">destination</span><span class="o">.</span><span class="n">each_tip_needs_separate_item</span><span class="p">():</span>
            <span class="c1"># Reservoir: all tips dispense to same item</span>
            <span class="n">destination</span><span class="o">.</span><span class="n">validate_col_row_or_raise</span><span class="p">([</span><span class="n">dest_col</span><span class="p">],</span> <span class="n">dest_row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Plate: each tip dispenses to different item</span>
            <span class="n">destination</span><span class="o">.</span><span class="n">validate_col_row_or_raise</span><span class="p">([</span><span class="n">dest_col</span><span class="p">],</span> <span class="n">dest_row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_supports_content_management</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">dest_col</span><span class="p">,</span> <span class="n">dest_row</span><span class="p">):</span>
            <span class="c1"># Track content if supported</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dispense_with_content_tracking</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">dest_col</span><span class="p">,</span> <span class="n">dest_row</span><span class="p">,</span> <span class="n">volume</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  → Dispensed </span><span class="si">{</span><span class="n">volume</span><span class="si">}</span><span class="s2">µL to </span><span class="si">{</span><span class="n">destination</span><span class="o">.</span><span class="n">labware_id</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">dest_col_row</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  → Tip content now: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_tip_content_summary</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Just do physical movement without content tracking</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dispense_physical_only</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">dest_col</span><span class="p">,</span> <span class="n">dest_row</span><span class="p">,</span> <span class="n">volume</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  → Dispensed </span><span class="si">{</span><span class="n">volume</span><span class="si">}</span><span class="s2">µL to </span><span class="si">{</span><span class="n">destination</span><span class="o">.</span><span class="n">labware_id</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">dest_col_row</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipettorPlus.add_content">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.add_content">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">tip_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add content to specific tip(s).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        content_type : str</span>
<span class="sd">            Content to add (e.g., &quot;PBS&quot;, &quot;water&quot;)</span>
<span class="sd">        volume : float</span>
<span class="sd">            Volume to add (µL)</span>
<span class="sd">        tip_index : int, optional</span>
<span class="sd">            Which tip to add to (0-7 for multichannel, 0 for single).</span>
<span class="sd">            If None, adds to all tips equally.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">volume</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Volume to add must be positive&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">content_type</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Content type cannot be empty&quot;</span><span class="p">)</span>

        <span class="c1"># Determine which tips to update</span>
        <span class="k">if</span> <span class="n">tip_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tip_index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid tip index </span><span class="si">{</span><span class="n">tip_index</span><span class="si">}</span><span class="s2">. Valid range: 0-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tip_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">tip_index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Add to all tips</span>
            <span class="n">tip_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tip_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># Add content to each specified tip</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">tip_indices</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tip_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">content_type</span><span class="p">]</span> <span class="o">+=</span> <span class="n">volume</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tip_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">content_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume</span></div>


<div class="viewcode-block" id="PipettorPlus.remove_content">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.remove_content">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">tip_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove content from tip(s) proportionally.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        volume : float</span>
<span class="sd">            Volume to remove (µL)</span>
<span class="sd">        tip_index : int, optional</span>
<span class="sd">            Which tip to remove from. If None, removes from all tips.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">volume</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Volume to remove must be positive&quot;</span><span class="p">)</span>

        <span class="c1"># Determine which tips to update</span>
        <span class="k">if</span> <span class="n">tip_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tip_index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid tip index </span><span class="si">{</span><span class="n">tip_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tip_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">tip_index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tip_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tip_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># Remove from each tip</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">tip_indices</span><span class="p">:</span>
            <span class="n">tip_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">current_volume</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tip_content</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">if</span> <span class="n">tip_content</span> <span class="k">else</span> <span class="mf">0.0</span>

            <span class="k">if</span> <span class="n">current_volume</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot remove from empty tip </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">volume</span> <span class="o">&gt;</span> <span class="n">current_volume</span><span class="p">:</span>
                <span class="n">difference</span> <span class="o">=</span> <span class="n">volume</span> <span class="o">-</span> <span class="n">current_volume</span>
                <span class="k">if</span> <span class="n">difference</span> <span class="o">&lt;=</span> <span class="mf">0.01</span><span class="p">:</span>
                    <span class="n">volume</span> <span class="o">=</span> <span class="n">current_volume</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Underflow in tip </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">! Cannot remove </span><span class="si">{</span><span class="n">volume</span><span class="si">}</span><span class="s2">µL, only </span><span class="si">{</span><span class="n">current_volume</span><span class="si">}</span><span class="s2">µL available&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Remove proportionally</span>
            <span class="n">removal_ratio</span> <span class="o">=</span> <span class="n">volume</span> <span class="o">/</span> <span class="n">current_volume</span>
            <span class="n">content_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tip_content</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">content_type</span> <span class="ow">in</span> <span class="n">content_types</span><span class="p">:</span>
                <span class="n">remove_amount</span> <span class="o">=</span> <span class="n">tip_content</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span> <span class="o">*</span> <span class="n">removal_ratio</span>
                <span class="n">tip_content</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span> <span class="o">-=</span> <span class="n">remove_amount</span>

                <span class="k">if</span> <span class="n">tip_content</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">1e-6</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">tip_content</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span></div>


<div class="viewcode-block" id="PipettorPlus.home">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.home">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">home</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_xy</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipettorPlus.move_xy">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.move_xy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">move_xy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override parent to add simulation mode check&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_mode</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_abort_and_pause</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipettor</span><span class="o">.</span><span class="n">move_z</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipettor</span><span class="o">.</span><span class="n">move_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipettorPlus.move_z">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.move_z">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">move_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override parent to add simulation mode check&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_mode</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_abort_and_pause</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipettor</span><span class="o">.</span><span class="n">move_z</span><span class="p">(</span><span class="n">z</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipettorPlus.pick_tip">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.pick_tip">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pick_tip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override parent to add simulation mode check&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_mode</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_abort_and_pause</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipettor</span><span class="o">.</span><span class="n">pick_tip</span><span class="p">(</span><span class="n">z</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipettorPlus.eject_tip">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.eject_tip">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">eject_tip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override parent to add simulation mode check&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_mode</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_abort_and_pause</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipettor</span><span class="o">.</span><span class="n">eject_tip</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipettorPlus.aspirate">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.aspirate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">aspirate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override parent to add simulation mode check&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_mode</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_abort_and_pause</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipettor</span><span class="o">.</span><span class="n">aspirate</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipettorPlus.dispense">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.dispense">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">dispense</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override parent to add simulation mode check&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_mode</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_abort_and_pause</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipettor</span><span class="o">.</span><span class="n">dispense</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipettorPlus.measure_foc">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.measure_foc">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">measure_foc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">platename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">bat_script_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for specified seconds, then run FOC measurement script.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Use provided path or stored path</span>
        <span class="k">if</span> <span class="n">bat_script_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">foc_bat_script_path</span> <span class="o">=</span> <span class="n">bat_script_path</span>

        <span class="c1"># Use provided plate name or stored plate name</span>
        <span class="k">if</span> <span class="n">platename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plate_to_use</span> <span class="o">=</span> <span class="n">platename</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;foc_plate_name&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">foc_plate_name</span><span class="p">:</span>
            <span class="n">plate_to_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">foc_plate_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Plate name not provided and no plate name configured&quot;</span><span class="p">)</span>

        <span class="c1"># Check if we have a script path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;foc_bat_script_path&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">foc_bat_script_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;FOC bat script path not set. Please configure FOC first.&quot;</span><span class="p">)</span>

        <span class="c1"># Verify file exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">foc_bat_script_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FOC bat script not found at: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">foc_bat_script_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_mode</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SIMULATION] Would wait </span><span class="si">{</span><span class="n">seconds</span><span class="si">}</span><span class="s2"> seconds, then run FOC for plate &#39;</span><span class="si">{</span><span class="n">plate_to_use</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">return</span>  <span class="c1"># Exit early - don&#39;t run the actual script</span>

        <span class="c1"># Wait for specified time</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting </span><span class="si">{</span><span class="n">seconds</span><span class="si">}</span><span class="s2"> seconds before FOC measurement...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>

        <span class="c1"># Run the bat script</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_abort_and_pause</span><span class="p">()</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">foc_bat_script_path</span><span class="p">,</span> <span class="n">plate_to_use</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FOC measurement completed for </span><span class="si">{</span><span class="n">plate_to_use</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ERROR] Failed to run FOC measurement: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



    <span class="c1"># Helper Functions. Not necessarily available for gui</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">source_positions</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">destination_positions</span><span class="p">,</span>
                           <span class="n">source_consecutive_rows</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dest_consecutive_rows</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper: Validate source and destination positions.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_tips</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_tips</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No tips loaded. Pick tips first.&quot;</span><span class="p">)</span>

        <span class="c1"># Validate source positions</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source_positions</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">source_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">source_positions</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">source_col</span><span class="p">,</span> <span class="n">source_row</span> <span class="ow">in</span> <span class="n">source_positions</span><span class="p">:</span>
            <span class="n">source</span><span class="o">.</span><span class="n">validate_col_row_or_raise</span><span class="p">([</span><span class="n">source_col</span><span class="p">],</span> <span class="n">source_row</span><span class="p">,</span> <span class="n">source_consecutive_rows</span><span class="p">)</span>

        <span class="c1"># Validate destination positions</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">destination_positions</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">destination_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">destination_positions</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dest_col</span><span class="p">,</span> <span class="n">dest_row</span> <span class="ow">in</span> <span class="n">destination_positions</span><span class="p">:</span>
            <span class="n">destination</span><span class="o">.</span><span class="n">validate_col_row_or_raise</span><span class="p">([</span><span class="n">dest_col</span><span class="p">],</span> <span class="n">dest_row</span><span class="p">,</span> <span class="n">dest_consecutive_rows</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_multi_trip_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
                             <span class="n">volume_per_position</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_vol_per_aspirate</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                             <span class="n">source</span><span class="p">,</span> <span class="n">source_pos</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">dest_positions</span><span class="p">,</span>
                             <span class="n">is_one_to_many</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">mix_volume</span><span class="p">:</span><span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper: Handle multi-trip transfers when volume exceeds capacity.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        is_one_to_many : bool</span>
<span class="sd">            True for add_medium (1 source → many dests), False for remove_medium (many sources → 1 dest)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">→ Strategy: MULTI-TRIP (volume exceeds tip capacity)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
            <span class="n">col</span><span class="p">,</span> <span class="n">row</span> <span class="o">=</span> <span class="n">pos</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">check_tips</span><span class="p">()</span>

            <span class="n">num_trips</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="n">volume_per_position</span> <span class="o">/</span> <span class="n">max_vol_per_aspirate</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Position (</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">num_trips</span><span class="si">}</span><span class="s2"> trips needed&quot;</span><span class="p">)</span>

            <span class="c1"># Distribute volume evenly across trips</span>
            <span class="n">base_volume</span> <span class="o">=</span> <span class="n">volume_per_position</span> <span class="o">//</span> <span class="n">num_trips</span>
            <span class="n">remainder</span> <span class="o">=</span> <span class="n">volume_per_position</span> <span class="o">%</span> <span class="n">num_trips</span>

            <span class="k">for</span> <span class="n">trip_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_trips</span><span class="p">):</span>
                <span class="n">trip_volume</span> <span class="o">=</span> <span class="n">base_volume</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">trip_num</span> <span class="o">&lt;</span> <span class="n">remainder</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">is_one_to_many</span><span class="p">:</span>
                    <span class="c1"># add_medium: same source, different destinations</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">suck</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">source_pos</span><span class="p">,</span> <span class="n">trip_volume</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spit</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">trip_volume</span><span class="p">)</span>

                    <span class="c1"># Mix after LAST trip only</span>
                    <span class="k">if</span> <span class="n">mix_volume</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">trip_num</span> <span class="o">==</span> <span class="n">num_trips</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">actual_mix_vol</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">mix_volume</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_volume</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    → Mixing with </span><span class="si">{</span><span class="n">actual_mix_vol</span><span class="si">}</span><span class="s2">µL&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">suck</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">actual_mix_vol</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">spit</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">actual_mix_vol</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># remove_medium: different sources, same destination</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">suck</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">trip_volume</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spit</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">dest_positions</span><span class="p">,</span> <span class="n">trip_volume</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ Multi-trip transfer complete</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_batch_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
                        <span class="n">volume_per_position</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_vol_per_aspirate</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                        <span class="n">source</span><span class="p">,</span> <span class="n">source_pos</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">dest_pos</span><span class="p">,</span>
                        <span class="n">is_one_to_many</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">mix_volume</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper: Handle batch transfers for multiple positions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        is_one_to_many : bool</span>
<span class="sd">            True for add_medium (1 source → many dests), False for remove_medium (many sources → 1 dest)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">→ Strategy: BATCH MODE&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate optimal batch size</span>
        <span class="n">max_positions_by_volume</span> <span class="o">=</span> <span class="n">max_vol_per_aspirate</span> <span class="o">//</span> <span class="n">volume_per_position</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_positions_by_volume</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">num_batches</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch size: </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2"> position(s) per aspirate&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total batches: </span><span class="si">{</span><span class="n">num_batches</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Process positions in batches</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">batch_num</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">):</span>
            <span class="n">batch_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">))</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">batch_end</span><span class="p">]</span>
            <span class="n">total_batch_volume</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">*</span> <span class="n">volume_per_position</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">check_tips</span><span class="p">()</span> <span class="c1">#change tip between batches if change_tip is True</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch </span><span class="si">{</span><span class="n">batch_num</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_batches</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Positions: </span><span class="si">{</span><span class="n">batch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total volume: </span><span class="si">{</span><span class="n">total_batch_volume</span><span class="si">}</span><span class="s2">µL&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_one_to_many</span><span class="p">:</span>
                <span class="c1"># add_medium: aspirate once, dispense multiple times</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suck</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">source_pos</span><span class="p">,</span> <span class="n">total_batch_volume</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spit</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">volume_per_position</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ Dispensed to </span><span class="si">{</span><span class="n">pos</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">volume_per_position</span><span class="si">}</span><span class="s2">µL&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">mix_volume</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">actual_mix_vol</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">mix_volume</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_volume</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    → Mixing with </span><span class="si">{</span><span class="n">actual_mix_vol</span><span class="si">}</span><span class="s2">µL&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">suck</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">actual_mix_vol</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">spit</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">actual_mix_vol</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># remove_medium: aspirate multiple times, dispense once</span>
                <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">suck</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">volume_per_position</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ Aspirated from </span><span class="si">{</span><span class="n">pos</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">volume_per_position</span><span class="si">}</span><span class="s2">µL&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spit</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">dest_pos</span><span class="p">,</span> <span class="n">total_batch_volume</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ Dispensed to destination: </span><span class="si">{</span><span class="n">total_batch_volume</span><span class="si">}</span><span class="s2">µL&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">()</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">batch_end</span>
            <span class="n">batch_num</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ Batch transfer complete</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_aspirate_with_content_tracking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">Labware</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aspirate with content tracking.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_abort_and_pause</span><span class="p">()</span>
        <span class="c1"># Check if each tip needs separate item</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multichannel</span> <span class="ow">and</span> <span class="n">source</span><span class="o">.</span><span class="n">each_tip_needs_separate_item</span><span class="p">():</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_content_item</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="p">)]</span>
            <span class="n">volume_per_item</span> <span class="o">=</span> <span class="n">volume</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_content_item</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">)]</span>
            <span class="n">volume_per_item</span> <span class="o">=</span> <span class="n">volume</span>

        <span class="c1"># Validate items exist</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Content item not found at position (</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># Check total available volume</span>
        <span class="n">total_available</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get_total_volume</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="n">item</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_available</span> <span class="o">&lt;</span> <span class="n">volume</span><span class="p">:</span>
            <span class="n">difference</span> <span class="o">=</span> <span class="n">volume</span> <span class="o">-</span> <span class="n">total_available</span>
            <span class="k">if</span> <span class="n">difference</span> <span class="o">&lt;=</span> <span class="mf">0.01</span><span class="p">:</span>
                <span class="n">volume</span> <span class="o">=</span> <span class="n">total_available</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Insufficient volume. Available: </span><span class="si">{</span><span class="n">total_available</span><span class="si">}</span><span class="s2">µL, Requested: </span><span class="si">{</span><span class="n">volume</span><span class="si">}</span><span class="s2">µL&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Remove content from source and add to tips</span>
        <span class="k">for</span> <span class="n">tip_idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">and</span> <span class="n">volume_per_item</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">removed_content</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">remove_content</span><span class="p">(</span><span class="n">volume_per_item</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">multichannel</span><span class="p">:</span>
                    <span class="c1"># Distribute to all tips</span>
                    <span class="k">for</span> <span class="n">tip_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">vol</span> <span class="ow">in</span> <span class="n">removed_content</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">vol</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">add_content</span><span class="p">(</span><span class="n">content_type</span><span class="p">,</span> <span class="n">vol</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="p">,</span> <span class="n">tip_index</span><span class="o">=</span><span class="n">tip_i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Each tip gets from its own item</span>
                    <span class="k">for</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">vol</span> <span class="ow">in</span> <span class="n">removed_content</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">vol</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_content</span><span class="p">(</span><span class="n">content_type</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="n">tip_index</span><span class="o">=</span><span class="n">tip_idx</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_move_to_and_aspirate</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">volume</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_aspirate_physical_only</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">Labware</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aspirate without content tracking.&quot;&quot;&quot;</span>

        <span class="c1"># Get items (same logic as content tracking)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multichannel</span> <span class="ow">and</span> <span class="n">source</span><span class="o">.</span><span class="n">each_tip_needs_separate_item</span><span class="p">():</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_content_item</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_content_item</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">if</span> <span class="n">item</span> <span class="k">else</span> <span class="n">source</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_move_to_and_aspirate</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">volume</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  → Note: Content tracking not available for </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_dispense_with_content_tracking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destination</span><span class="p">:</span> <span class="n">Labware</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dispense with content tracking.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_abort_and_pause</span><span class="p">()</span>
        <span class="c1"># Check if each tip needs separate destination item. get item/items</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multichannel</span> <span class="ow">and</span> <span class="n">destination</span><span class="o">.</span><span class="n">each_tip_needs_separate_item</span><span class="p">():</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_content_item</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="p">)]</span>
            <span class="n">volume_per_item</span> <span class="o">=</span> <span class="n">volume</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_content_item</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">)]</span>
            <span class="n">volume_per_item</span> <span class="o">=</span> <span class="n">volume</span>

        <span class="c1"># Validate items exist</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Content item not found at position (</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># Transfer content from tips to destination</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">multichannel</span><span class="p">:</span>
            <span class="c1"># All tips dispense to one item (like Reservoir)</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">tip_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="p">):</span>
                <span class="n">tip_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_dict</span><span class="p">[</span><span class="n">tip_idx</span><span class="p">]</span>
                <span class="n">tip_total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tip_content</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">if</span> <span class="n">tip_content</span> <span class="k">else</span> <span class="mf">0.0</span>

                <span class="k">if</span> <span class="n">tip_total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">tip_volume_to_dispense</span> <span class="o">=</span> <span class="n">volume</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span>
                    <span class="n">removal_ratio</span> <span class="o">=</span> <span class="n">tip_volume_to_dispense</span> <span class="o">/</span> <span class="n">tip_total</span>

                    <span class="k">for</span> <span class="n">content_type</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">tip_content</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">remove_amount</span> <span class="o">=</span> <span class="n">tip_content</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span> <span class="o">*</span> <span class="n">removal_ratio</span>
                        <span class="n">item</span><span class="o">.</span><span class="n">add_content</span><span class="p">(</span><span class="n">content_type</span><span class="p">,</span> <span class="n">remove_amount</span><span class="p">)</span>
                        <span class="n">tip_content</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span> <span class="o">-=</span> <span class="n">remove_amount</span>
                        <span class="k">if</span> <span class="n">tip_content</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">1e-6</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">tip_content</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Each tip dispenses to its own item (like wells in plate)</span>
            <span class="k">for</span> <span class="n">tip_idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">and</span> <span class="n">volume_per_item</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">tip_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_dict</span><span class="p">[</span><span class="n">tip_idx</span><span class="p">]</span>
                    <span class="n">tip_total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tip_content</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">if</span> <span class="n">tip_content</span> <span class="k">else</span> <span class="mf">0.0</span>

                    <span class="k">if</span> <span class="n">tip_total</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">removal_ratio</span> <span class="o">=</span> <span class="n">volume_per_item</span> <span class="o">/</span> <span class="n">tip_total</span>

                    <span class="k">for</span> <span class="n">content_type</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">tip_content</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">remove_amount</span> <span class="o">=</span> <span class="n">tip_content</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span> <span class="o">*</span> <span class="n">removal_ratio</span>
                        <span class="n">item</span><span class="o">.</span><span class="n">add_content</span><span class="p">(</span><span class="n">content_type</span><span class="p">,</span> <span class="n">remove_amount</span><span class="p">)</span>
                        <span class="n">tip_content</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span> <span class="o">-=</span> <span class="n">remove_amount</span>
                        <span class="k">if</span> <span class="n">tip_content</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">1e-6</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">tip_content</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_move_to_and_dispense</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">volume</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_dispense_physical_only</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destination</span><span class="p">:</span> <span class="n">Labware</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dispense without content tracking.&quot;&quot;&quot;</span>

        <span class="c1"># Get items</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multichannel</span> <span class="ow">and</span> <span class="n">destination</span><span class="o">.</span><span class="n">each_tip_needs_separate_item</span><span class="p">():</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_content_item</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_content_item</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">if</span> <span class="n">item</span> <span class="k">else</span> <span class="n">destination</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_move_to_and_dispense</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">volume</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  → Note: Content tracking not available for </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_move_to_and_aspirate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Labware</span><span class="p">],</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move to position and perform aspiration.</span>

<span class="sd">        For multichannel, moves to the CENTER of all tip positions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        items : List[Labware]</span>
<span class="sd">            List of items to aspirate from (1 for single channel, 8 for multichannel)</span>
<span class="sd">        volume : float</span>
<span class="sd">            Total volume to aspirate</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No items provided&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate center position for robot movement</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_robot_xy_position</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

        <span class="c1"># Use first item for height calculation</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">relative_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relative_z</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="n">volume</span><span class="p">)</span>
        <span class="n">parent_labware</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_parent_labware</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">pipettor_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pipettor_z_coord</span><span class="p">(</span><span class="n">parent_labware</span><span class="p">,</span> <span class="n">relative_z</span><span class="p">,</span> <span class="n">child_item</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x, y, z = </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">pipettor_z</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_z</span><span class="p">(</span><span class="n">pipettor_z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aspirate</span><span class="p">(</span><span class="n">volume</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_z</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_move_to_and_dispense</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Labware</span><span class="p">],</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move to position and perform dispense.</span>

<span class="sd">        For multichannel, moves to the CENTER of all tip positions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        items : List[Labware]</span>
<span class="sd">            List of items to dispense to (1 for single channel, 8 for multichannel)</span>
<span class="sd">        volume : float</span>
<span class="sd">            Total volume to dispense</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No items provided&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate center position for robot movement</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_robot_xy_position</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

        <span class="c1"># Use first item for height calculation</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">parent_labware</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_parent_labware</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">relative_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relative_z</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="n">volume</span><span class="p">)</span>
        <span class="n">pipettor_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pipettor_z_coord</span><span class="p">(</span><span class="n">parent_labware</span><span class="p">,</span> <span class="n">relative_z</span><span class="p">,</span> <span class="n">child_item</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x, y, z = </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">pipettor_z</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">move_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_z</span><span class="p">(</span><span class="n">pipettor_z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispense</span><span class="p">(</span><span class="n">volume</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_z</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_supports_content_management</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labware</span><span class="p">:</span> <span class="n">Labware</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if labware supports content tracking at this position.&quot;&quot;&quot;</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_content_item</span><span class="p">(</span><span class="n">labware</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;remove_content&#39;</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;add_content&#39;</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;get_total_volume&#39;</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_content_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labware</span><span class="p">:</span> <span class="n">Labware</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the actual item that holds content at a position.</span>

<span class="sd">        Uses duck typing to work with any labware structure:</span>
<span class="sd">        - If it has get_well_at(), it&#39;s a Plate-like structure</span>
<span class="sd">        - If it has reservoir mapping methods, it&#39;s a ReservoirHolder-like structure</span>
<span class="sd">        - Otherwise, the labware itself might hold content</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Try Plate-like: get_well_at(col, row)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">labware</span><span class="p">,</span> <span class="s1">&#39;get_well_at&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">labware</span><span class="o">.</span><span class="n">get_well_at</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

        <span class="c1"># Try ReservoirHolder-like: position_to_hook_id + get_hook_to_reservoir_map</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">labware</span><span class="p">,</span> <span class="s1">&#39;position_to_hook_id&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">labware</span><span class="p">,</span> <span class="s1">&#39;get_hook_to_reservoir_map&#39;</span><span class="p">):</span>
            <span class="n">hook_id</span> <span class="o">=</span> <span class="n">labware</span><span class="o">.</span><span class="n">position_to_hook_id</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">labware</span><span class="o">.</span><span class="n">get_hook_to_reservoir_map</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hook_id</span><span class="p">)</span>

        <span class="c1"># Direct content holder: the labware itself has content</span>
        <span class="k">return</span> <span class="n">labware</span>

<div class="viewcode-block" id="PipettorPlus.get_total_tip_volume">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.get_total_tip_volume">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_total_tip_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tip_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get total volume in tip(s).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tip_index : int, optional</span>
<span class="sd">            Specific tip. If None, returns total across all tips.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Total volume in µL</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tip_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tip_dict</span><span class="p">[</span><span class="n">tip_index</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_dict</span><span class="p">[</span><span class="n">tip_index</span><span class="p">]</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Sum across all tips</span>
            <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">tip_content</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tip_content</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">if</span> <span class="n">tip_content</span> <span class="k">else</span> <span class="mf">0.0</span>
            <span class="k">return</span> <span class="n">total</span></div>


<div class="viewcode-block" id="PipettorPlus.initialize_tips">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.initialize_tips">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_tips</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear tip content when tips are discarded.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_tips</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tip_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="p">)}</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  → Tips discarded, content cleared&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_per_well</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper: Calculate volume per position and max volume per aspirate.&quot;&quot;&quot;</span>
        <span class="n">volume_per_position</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">volume_per_well</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="p">)</span>
        <span class="n">max_vol_per_aspirate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tip_volume</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="p">)</span> <span class="c1"># to prevent piston overdrive</span>


        <span class="k">if</span> <span class="n">volume_per_position</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;volume_per_well must be &gt; 0&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">volume_per_position</span><span class="p">,</span> <span class="n">max_vol_per_aspirate</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_tip_content_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a readable summary of tip content across all tips.&quot;&quot;&quot;</span>
        <span class="n">total_volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_total_tip_volume</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_dict</span> <span class="ow">or</span> <span class="n">total_volume</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;empty&quot;</span>

        <span class="c1"># Aggregate content across all tips</span>
        <span class="n">aggregated_content</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">tip_content</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">tip_content</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">content_type</span> <span class="ow">in</span> <span class="n">aggregated_content</span><span class="p">:</span>
                    <span class="n">aggregated_content</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span> <span class="o">+=</span> <span class="n">volume</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">aggregated_content</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">aggregated_content</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">content_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">volume</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">µL&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

<div class="viewcode-block" id="PipettorPlus.get_tip_status">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.get_tip_status">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_tip_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current tip status.&quot;&quot;&quot;</span>
        <span class="n">total_volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_total_tip_volume</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;content_dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="s2">&quot;volume_remaining&quot;</span><span class="p">:</span> <span class="n">total_volume</span><span class="p">,</span>
            <span class="s2">&quot;is_empty&quot;</span><span class="p">:</span> <span class="n">total_volume</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;content_summary&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tip_content_summary</span><span class="p">()</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="PipettorPlus.check_tips">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.check_tips">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_tips</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if tip change is required. if yes, do it.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">lw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_labware_by_type</span><span class="p">(</span><span class="s2">&quot;PipetteHolder&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Gets first PipetteHolder found</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">discard_lw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_labware_by_type</span><span class="p">(</span><span class="s2">&quot;TipDropzone&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">discard_lw</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_tips</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_tips</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pick_tips</span><span class="p">(</span><span class="n">lw</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_tips</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_tips</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">discard_lw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">discard_tips</span><span class="p">(</span><span class="n">discard_lw</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pick_tips</span><span class="p">(</span><span class="n">lw</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">replace_tips</span><span class="p">(</span><span class="n">lw</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_tips</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No tips loaded. Pick tips first.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipettorPlus.find_labware_by_type">
<a class="viewcode-back" href="../../../api.html#biohit_pipettor_plus.pipettor_plus.pipettor_plus.PipettorPlus.find_labware_by_type">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_labware_by_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labware_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Labware</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find a labware instance by its type name (case-sensitive).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        labware_type : str</span>
<span class="sd">            The class name of the labware to find (e.g., &quot;Plate&quot;, &quot;ReservoirHolder&quot;, &quot;PipetteHolder&quot;)</span>
<span class="sd">            Case-sensitive.</span>

<span class="sd">        Returns list of Labwares</span>
<span class="sd">            Any Labware instance of the specified type, placed in deck and slot.</span>

<span class="sd">        Raises ValueError</span>
<span class="sd">            If no labware of the specified type is found in the deck and placed in a slot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Iterate through all labware in the deck</span>
        <span class="n">lw</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">labware_id</span><span class="p">,</span> <span class="n">labware</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deck</span><span class="o">.</span><span class="n">labware</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Check if the labware&#39;s class name matches the requested type (case-sensitive)</span>
            <span class="k">if</span> <span class="n">labware</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">labware_type</span><span class="p">:</span>
                <span class="c1"># Check if this labware is placed in a slot ( in all slots placed in deck)</span>
                <span class="n">slot_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deck</span><span class="o">.</span><span class="n">get_slot_for_labware</span><span class="p">(</span><span class="n">labware_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">slot_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labware</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">lw</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No labware found for type &#39;</span><span class="si">{</span><span class="n">labware_type</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">lw</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_find_parent_labware</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Labware</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Labware</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the parent labware that contains this item.</span>

<span class="sd">        For a Well, the parent is the Plate.</span>
<span class="sd">        For a Reservoir, the parent is the ReservoirHolder.</span>
<span class="sd">        For standalone labware, returns the item itself.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if this item IS the top-level labware</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">labware_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deck</span><span class="o">.</span><span class="n">labware</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">item</span>

        <span class="c1"># Otherwise, search through all labware to find which one contains this item</span>
        <span class="k">for</span> <span class="n">labware_id</span><span class="p">,</span> <span class="n">labware</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deck</span><span class="o">.</span><span class="n">labware</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Check if it&#39;s a Plate containing this well</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">labware</span><span class="p">,</span> <span class="s1">&#39;get_wells&#39;</span><span class="p">):</span>
                <span class="n">wells</span> <span class="o">=</span> <span class="n">labware</span><span class="o">.</span><span class="n">get_wells</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">well</span> <span class="ow">in</span> <span class="n">wells</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">well</span> <span class="ow">and</span> <span class="n">well</span><span class="o">.</span><span class="n">labware_id</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">labware_id</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">labware</span>

            <span class="c1"># Check if it&#39;s a ReservoirHolder containing this reservoir</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">labware</span><span class="p">,</span> <span class="s1">&#39;get_reservoirs&#39;</span><span class="p">):</span>
                <span class="n">reservoirs</span> <span class="o">=</span> <span class="n">labware</span><span class="o">.</span><span class="n">get_reservoirs</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">reservoir</span> <span class="ow">in</span> <span class="n">reservoirs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">reservoir</span><span class="o">.</span><span class="n">labware_id</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">labware_id</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">labware</span>

            <span class="c1"># Check if it&#39;s a PipetteHolder containing this individual holder</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">labware</span><span class="p">,</span> <span class="s1">&#39;get_individual_holders&#39;</span><span class="p">):</span>
                <span class="n">holders</span> <span class="o">=</span> <span class="n">labware</span><span class="o">.</span><span class="n">get_individual_holders</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">holder</span> <span class="ow">in</span> <span class="n">holders</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">holder</span> <span class="ow">and</span> <span class="n">holder</span><span class="o">.</span><span class="n">labware_id</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">labware_id</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">labware</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find parent labware for item </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">labware_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_relative_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Labware</span><span class="p">,</span> <span class="n">remove</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the relative z of the item.</span>

<span class="sd">        Parameters</span>
<span class="sd">         ----------</span>
<span class="sd">        item : Labware</span>
<span class="sd">            The parent labware (Plate, ReservoirHolder, PipetteHolder, etc.)</span>

<span class="sd">        remove: bool</span>
<span class="sd">            Whether to aspirate medium/pick tip or to add medium/eject tip.</span>

<span class="sd">        volume : float, optional</span>
<span class="sd">            Volume for dynamic height calculation (if applicable)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">item_type</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">if</span> <span class="n">item_type</span> <span class="o">==</span> <span class="s2">&quot;TipDropzone&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;drop_height_relative&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">size_z</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">item_type</span> <span class="o">==</span> <span class="s2">&quot;IndividualPipetteHolder&quot;</span><span class="p">:</span>
            <span class="n">parent_labware</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_parent_labware</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parent_labware</span><span class="p">,</span> <span class="s1">&#39;remove_height&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">size_z</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parent_labware</span><span class="p">,</span> <span class="s1">&#39;add_height&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">size_z</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">item_type</span> <span class="o">==</span> <span class="s2">&quot;PipetteHolder&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;remove_height&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">size_z</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;add_height&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">size_z</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">item_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Reservoir&quot;</span><span class="p">,</span> <span class="s2">&quot;Well&quot;</span><span class="p">]:</span>
            <span class="n">parent_labware</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_parent_labware</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
                <span class="c1"># Aspiration logic</span>
                <span class="k">if</span> <span class="n">volume</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                    <span class="c1"># Dynamic aspiration based on liquid level</span>
                    <span class="k">if</span> <span class="n">parent_labware</span><span class="o">.</span><span class="n">each_tip_needs_separate_item</span><span class="p">():</span>
                        <span class="n">volume_per_tip</span> <span class="o">=</span> <span class="n">volume</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span>
                        <span class="n">relative_z</span> <span class="o">=</span> <span class="n">calculate_dynamic_remove_height</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">volume_per_tip</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">relative_z</span> <span class="o">=</span> <span class="n">calculate_dynamic_remove_height</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">volume</span><span class="p">)</span>
                    <span class="n">liquid_height</span> <span class="o">=</span> <span class="n">calculate_liquid_height</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  → Dynamic aspiration: </span><span class="si">{</span><span class="n">relative_z</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">mm from bottom &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;(liquid: </span><span class="si">{</span><span class="n">liquid_height</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">mm, shape: </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">relative_z</span>

                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parent_labware</span><span class="p">,</span> <span class="s1">&#39;remove_height&#39;</span><span class="p">):</span>
                    <span class="n">relative_z</span> <span class="o">=</span> <span class="n">parent_labware</span><span class="o">.</span><span class="n">remove_height</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  → Fixed aspiration: </span><span class="si">{</span><span class="n">relative_z</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">mm from bottom&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">relative_z</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">relative_z</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">size_z</span> <span class="o">*</span> <span class="mf">0.75</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  → Fallback aspiration: 5 mm above bottom&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">relative_z</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Determine RELATIVE height from labware BOTTOM</span>
                <span class="k">if</span> <span class="n">volume</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                    <span class="n">volume_per_tip</span> <span class="o">=</span> <span class="n">volume</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span>
                    <span class="k">if</span> <span class="n">parent_labware</span><span class="o">.</span><span class="n">each_tip_needs_separate_item</span><span class="p">():</span>
                        <span class="n">relative_z</span> <span class="o">=</span> <span class="n">calculate_dynamic_remove_height</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="o">-</span><span class="n">volume_per_tip</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">relative_z</span> <span class="o">=</span> <span class="n">calculate_dynamic_remove_height</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="o">-</span><span class="n">volume</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span>
                    <span class="n">liquid_height</span> <span class="o">=</span> <span class="n">calculate_liquid_height</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  → Dynamic dispensing: </span><span class="si">{</span><span class="n">relative_z</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">mm from bottom &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;(liquid: </span><span class="si">{</span><span class="n">liquid_height</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">mm, shape: </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">relative_z</span>

                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parent_labware</span><span class="p">,</span> <span class="s1">&#39;add_height&#39;</span><span class="p">):</span>
                    <span class="n">relative_z</span> <span class="o">=</span> <span class="n">parent_labware</span><span class="o">.</span><span class="n">add_height</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  → Fixed dispensing: </span><span class="si">{</span><span class="n">relative_z</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">mm from bottom&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">relative_z</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">relative_z</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">size_z</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  → Fallback dispensing: item.size_z&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">relative_z</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  → Warning: Unknown item type &#39;</span><span class="si">{</span><span class="n">item_type</span><span class="si">}</span><span class="s2">&#39;, using size_z&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">size_z</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_pipettor_z_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labware</span><span class="p">:</span><span class="n">Labware</span><span class="p">,</span> <span class="n">relative_z</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">child_item</span><span class="p">:</span> <span class="n">Labware</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert relative height to absolute height, passable to pipettor with and without tips.</span>

<span class="sd">        If child_item is provided, the calculation is based on the child&#39;s bottom position.</span>
<span class="sd">        Otherwise, it&#39;s based on the labware&#39;s bottom.</span>

<span class="sd">        Parameters</span>
<span class="sd">         ----------</span>
<span class="sd">        labware : Labware</span>
<span class="sd">            The parent labware (Plate, ReservoirHolder, PipetteHolder, etc.)</span>
<span class="sd">        relative_z : float</span>
<span class="sd">            Height relative to the BOTTOM of the child item (or labware if no child):</span>
<span class="sd">            - 0 = bottom of well/reservoir/holder</span>
<span class="sd">            - Positive values = higher up from bottom</span>
<span class="sd">        child_item : Labware, optional</span>
<span class="sd">            The specific child item being accessed (Well, Reservoir, IndividualPipetteHolder).</span>
<span class="sd">            If None, uses labware&#39;s bottom as reference.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Pipettor Z coordinate (how far down pipettor moves from home position)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Find the slot that contains this labware. essential to get min_z and max_z</span>
        <span class="n">slot_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deck</span><span class="o">.</span><span class="n">get_slot_for_labware</span><span class="p">(</span><span class="n">labware</span><span class="o">.</span><span class="n">labware_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">slot_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Labware </span><span class="si">{</span><span class="n">labware</span><span class="o">.</span><span class="n">labware_id</span><span class="si">}</span><span class="s2"> is not placed in any slot&quot;</span><span class="p">)</span>

        <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slots</span><span class="p">[</span><span class="n">slot_id</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">labware</span><span class="o">.</span><span class="n">labware_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slot</span><span class="o">.</span><span class="n">labware_stack</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Labware </span><span class="si">{</span><span class="n">labware</span><span class="o">.</span><span class="n">labware_id</span><span class="si">}</span><span class="s2"> not found in slot </span><span class="si">{</span><span class="n">slot_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">min_z</span><span class="p">,</span> <span class="n">max_z</span><span class="p">)</span> <span class="o">=</span> <span class="n">slot</span><span class="o">.</span><span class="n">labware_stack</span><span class="p">[</span><span class="n">labware</span><span class="o">.</span><span class="n">labware_id</span><span class="p">]</span>

        <span class="c1"># Determine child depth</span>
        <span class="n">child_depth</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="n">child_item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">child_depth</span> <span class="o">=</span> <span class="n">child_item</span><span class="o">.</span><span class="n">size_z</span>


        <span class="n">reference_bottom</span> <span class="o">=</span> <span class="n">max_z</span> <span class="o">-</span> <span class="n">child_depth</span>
        <span class="n">absolute_height</span> <span class="o">=</span> <span class="n">reference_bottom</span> <span class="o">+</span> <span class="n">relative_z</span>
        <span class="c1">#print(f&quot;reference_bottom({reference_bottom}) = max_z({max_z}) - child_depth ({child_depth})&quot;)</span>
        <span class="c1">#print(f&quot;absolute_height ({absolute_height}) = reference_bottom ({reference_bottom})+ liquid_height({relative_z}) &quot;)</span>

        <span class="k">if</span> <span class="n">absolute_height</span> <span class="o">&lt;</span> <span class="n">reference_bottom</span><span class="p">:</span>
            <span class="c1">#print(f&quot;absolute_height({absolute_height}) cannot be less than reference_bottom({reference_bottom}). New Absolute height = {reference_bottom} + 1&quot;)</span>
            <span class="n">absolute_height</span> <span class="o">=</span> <span class="n">reference_bottom</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">deck_range_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deck</span><span class="o">.</span><span class="n">range_z</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_tips</span><span class="p">:</span>
            <span class="n">pipettor_z</span> <span class="o">=</span> <span class="n">deck_range_z</span> <span class="o">-</span> <span class="n">absolute_height</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_length</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; has_tips: pipettor_z(</span><span class="si">{</span><span class="n">pipettor_z</span><span class="si">}</span><span class="s2">) = deck_range_z(</span><span class="si">{</span><span class="n">deck_range_z</span><span class="si">}</span><span class="s2">) - absolute_height (</span><span class="si">{</span><span class="n">absolute_height</span><span class="si">}</span><span class="s2">) - self.tip_length(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tip_length</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="c1"># Validation with tips</span>
            <span class="k">if</span> <span class="n">pipettor_z</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot reach pipettor_z=</span><span class="si">{</span><span class="n">pipettor_z</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">mm with tips attached &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Maximum reachable height: </span><span class="si">{</span><span class="n">deck_range_z</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">tip_length</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">mm &quot;</span>
                <span class="p">)</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">()</span>
            <span class="n">zmax</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;Z_MAX&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">pipettor_z</span> <span class="o">&gt;</span> <span class="n">zmax</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;pipettor_z cannot be higher than Z_MAX (</span><span class="si">{</span><span class="n">zmax</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> mm). Got </span><span class="si">{</span><span class="n">pipettor_z</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> mm.&quot;</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No tips - full range available</span>
            <span class="n">pipettor_z</span> <span class="o">=</span> <span class="n">deck_range_z</span> <span class="o">-</span> <span class="n">absolute_height</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No Tips: pipettor_z(</span><span class="si">{</span><span class="n">pipettor_z</span><span class="si">}</span><span class="s2">) = deck_range_z(</span><span class="si">{</span><span class="n">deck_range_z</span><span class="si">}</span><span class="s2">) - absolute_height (</span><span class="si">{</span><span class="n">absolute_height</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="c1"># Validation without tips</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">()</span>
            <span class="n">zmax</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;Z_MAX&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">pipettor_z</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Invalid height: absolute_z=</span><span class="si">{</span><span class="n">absolute_height</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">mm exceeds deck range=</span><span class="si">{</span><span class="n">deck_range_z</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">mm&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">pipettor_z</span> <span class="o">&gt;</span> <span class="n">zmax</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pipettor_z cannot be higher than (</span><span class="si">{</span><span class="n">zmax</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> mm). Got </span><span class="si">{</span><span class="n">pipettor_z</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">mm&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">pipettor_z</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_robot_xy_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Labware</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate where the robot arm should move to access the given items.</span>

<span class="sd">        The robot arm position depends on the pipettor configuration:</span>

<span class="sd">        Single channel (1 tip):</span>
<span class="sd">            Robot moves directly to the item&#39;s position.</span>
<span class="sd">            Robot arm = Tip position</span>

<span class="sd">        Multichannel (8 tips):</span>
<span class="sd">            Robot moves to the CENTER of all items.</span>
<span class="sd">            Robot arm is at geometric center, tips span from first to last item.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        items : List[Labware]</span>
<span class="sd">            Items to access. Must have 1 item for single channel,</span>
<span class="sd">            or tip_count items for multichannel.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple[float, float]</span>
<span class="sd">            (x, y) coordinates for robot arm movement</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Single channel accessing well (0,0) at position (10, 20):</span>
<span class="sd">            items = [well_0_0]</span>
<span class="sd">            Returns: (10, 20)</span>

<span class="sd">        Multichannel accessing wells (0,0) to (0,7):</span>
<span class="sd">            items = [well_0_0, well_0_1, ..., well_0_7]</span>
<span class="sd">            Well (0,0) at (10, 10), Well (0,7) at (10, 73)</span>
<span class="sd">            Returns: (10, 41.5) - the midpoint</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No items provided for positioning&quot;</span><span class="p">)</span>

        <span class="c1"># Single channel: use item position directly</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">multichannel</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Item </span><span class="si">{</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">labware_id</span><span class="si">}</span><span class="s2"> has no position set&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">position</span>

        <span class="c1"># Multichannel: calculate center of span</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span> <span class="ow">and</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">each_tip_needs_separate_item</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Multichannel requires </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tip_count</span><span class="si">}</span><span class="s2"> items, got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Get first and last positions</span>
        <span class="n">first_pos</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">position</span>
        <span class="n">last_pos</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">position</span>

        <span class="k">if</span> <span class="n">first_pos</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">last_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Items must have positions set&quot;</span><span class="p">)</span>

        <span class="n">x_first</span><span class="p">,</span> <span class="n">y_first</span> <span class="o">=</span> <span class="n">first_pos</span>
        <span class="n">x_last</span><span class="p">,</span> <span class="n">y_last</span> <span class="o">=</span> <span class="n">last_pos</span>

        <span class="c1"># Calculate center</span>
        <span class="n">x_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_first</span> <span class="o">+</span> <span class="n">x_last</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">y_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_first</span> <span class="o">+</span> <span class="n">y_last</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multichannel</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  → Multichannel positioning: center (</span><span class="si">{</span><span class="n">x_center</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y_center</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">) &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;spanning (</span><span class="si">{</span><span class="n">x_first</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">y_first</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">) to (</span><span class="si">{</span><span class="n">x_last</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">y_last</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x_center</span><span class="p">,</span> <span class="n">y_center</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">biohit-pipettor-plus  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">biohit_pipettor_plus.pipettor_plus.pipettor_plus</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2026, Advait Lath.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    </div>
  </body>
</html>